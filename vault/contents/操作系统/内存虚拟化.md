---
created_at: 2023-10-02
modified_at: 2023-10-02
description: 
aliases: 
tags:
  - 操作系统
title: 内存虚拟化
---
## 内存管理的基本要求
- 内存的分配与回收
- 地址转换 
- 内存空间扩容
- 内存共享 
- 存储保护
### 程序的链接与装入
- 编译
- 链接
	- 静态~
	- 装入动态~
	- 运行时动态~
- 装入
	- 绝对装入
	- 可重定位装入
		- 静态~
		- 动态~
### 逻辑地址与物理地址
### 程序的内存映像
### 内存保护
基址寄存器和界限寄存器
### 内存共享
可重入代码
### 内存分配与回收
## 内存碎片
外部碎片内部碎片
## 连续分配
### 静态分配方式
- 单一分配
- 固定分区分配 
	- 分区大小相等
	- ~不相等
- 动态分区分配 -> [[#动态分区分配算法|策略]]

||作业道数|内部碎片|外部碎片|硬件支持|管理空间的数据结构|解决空间不足的方法|提高作业道数|
|--|--|--|--|--|--|--|--|
|单道连续分配|1|O|X|界地址寄存器 越界检查||覆盖|交换|
|多道固定连续分配|小于分的块数|O|X|基址寄存器界限寄存器动态地址转换|空闲链表 空闲表||||
|多道可变连续分配|不好说|X|O|同上|同上|紧凑|||
### 动态分区分配算法
#### 基于空闲链表
- 首次匹配
	- 快
	- 对各个部分的内存磨损不一致, 内存起始部分容易出现碎片
- 下次匹配
	- 不如首次匹配
	- 尾部磨损严重
- 最佳匹配
	- 慢
	- 碎片化严重
- 最差匹配
	- 慢
	- 浪费大内存块
	- 碎片化不严重
#### 基于索引
- 快速匹配
- 伙伴算法
- 哈希算法
## 非连续分配
### 方式
- 段式分配
	段号 页内偏移 段表 段式逻辑地址是二维结构的
- 页式分配
	页 虚拟页号 物理页号 页内偏移
- 段页式分配

## 页式存储概念
- 页表 存在位 内存块地址 脏位访问位 权限位rwx 算法位（lru算法位、fifo算法位、clock算法位）...
- 多级页表
- 页表项
- 页表基址寄存器
- TLB
## （页式）虚拟内存管理
### 传统存储管理方式特征
- **一次性**
- **驻留性**
### 虚拟存储器的定义和特征
基于**局部性原理**
- **多次性**
- **对换性**
- **虚拟性**
### 请求分页管理机制
#### 页表
#### 缺页中断机构
![20231003231906](https://r2.pipago360.site/pupahub/2024/09/8b281cedb90f87eab6231486a023584e.png)
#### 地址变换机构
![20231003232217](https://r2.pipago360.site/pupahub/2024/09/fdb798d14981a25690de21b2b88a5548.png)
访问内存，为地址变换额外产生的开销
- tlb命中 是一次tlb访问
- tlb不命中页表命中 **（不考虑页表是否在cache中对页表的访问视为一次访存）一次tlb访问+n次内存访问（多级页表）+修改tlb的开销**
- tlb不命中页表也不命中触发页故障 **一次tlb访问+n次内存访问（多级页表）+缺页终端处理程序+修改页表与tlb+访问tlb（再次执行产生中断的指令）**
### 页面分配
#### 驻留集
指请求分页存储管理中给进程分配的物理块的集合
太大浪费
太小频繁的处理缺页异常
#### 分配策略
- 局部固定分配
	- 平均分配
	- 按比例分配
	- 优先权分配
- 局部可变分配
- 全局可变分配
- <span style="text-decoration-line: line-through;">全局固定分配</span>**不存在**
#### 时机
- 预调页策略 --> 立刻分配
- 请求调页策略 --> 惰性分配
#### 从何处调入页面
1.  系统拥有足够的对换区空间
    - 页面的调入、调出都是在内存与对换区之间进行，这样可以保证页面的调入、调出速度很快。
    - 在进程运行前，需将进程相关的数据从文件区复制到对换区
2. 系统缺少足够的对换区空间
    - 凡是不会被修改的数据都直接从文件区调入，由于这些页面不会被修改，因此换出时不必写回磁盘，下次需要时再从文件区调入即可。
    - 对于可能被修改的部分，换出时需写回磁盘对换区，下次需要时再从对换区调入。
3. UNIX方式
    - 运行之前进程有关的数据全部放在文件区，故未使用过的页面，都可从文件区调入。
    - 若被使用过的页面需要换出，则写回对换区，下次需要时从对换区调入。
### 缓存淘汰策略
[[../计算机组成原理/存储系统/缓存淘汰策略|缓存淘汰策略]]
## 工作集
### 概念 
工作窗口、工作时间
与驻留集不同，工作集指的是在某段时间间隔（工作时间之前的一段工作窗口）里，进程**实际访问页面**的集合。
工作集的大小若大于驻留集，则会发生[[../计算机组成原理/存储系统/cache#抖动|抖动]]现象。
## Memory Mapped File
## 虚拟内存存储器的性能分析
- 指标**缺页率** 
- 指导思想：**局部性原理**
- 大页缺页低
- 驻留集大小
- 页面置换策略
- 局部性好的程序 数组按行访问还是按列访问
- 写回磁盘的频率 **在系统中建立一分已修改换出页面的链表，对每个要被换出的页面（已修改），可以暂不将它们写回磁盘，而将它挂在该链表上，仅当被换出页面数达到给定值时，才将它们一起写回磁盘，这样就可显著滅少磁盘 1/O的次数，即减少已修改页面换出的开销。此外，若有进程在这批数据还未写回磁盘时需要再次访问这些页面，则不需从外存调入，而直接从已修改换出页面链表上获取，这样也可以减少页面从磁盘读入内存的频率，减少页面换进的开销**
## 其他
### 虚拟存储器的大小
- 虚拟存储器的大小：小于主存加外存的大小
- 虚拟存储器的最大大小/虚拟存储器地址空间大小：2^虚拟地址位数
### 虚拟存储器计算缺页率
[[../计算机组成原理/存储系统/cache#其他|详见]]
