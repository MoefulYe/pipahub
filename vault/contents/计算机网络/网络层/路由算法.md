---
created_at: 2024-07-28
modified_at: 2024-07-28
description: 
aliases: 
tags:
  - 计算机网络
title: 路由算法
---
## 路由算法
### 静态配置路由
程序员手动配置路由表
### 动态配置路由

#### 距离向量方法（Distance Vector）
- 理论基础 **Bellman-Ford算法**
- 维护的状态 **距离向量**（节点到其他节点的距离，包括自己节点和邻居节点）
- 大致流程
	当**邻居节点**向自己发送他自己的距离向量或者检测到链路状态发生变化（链路状态变化时要更新自己的距离向量）时检查是否有节点通过邻居的路由距离更短（$d(自己, 某节点) \gt d(邻居, 某节点) + c(自己, 邻居)$ d为与该节点对应距离向量的分量，c为某两个节点的直接距离）,如果有则更新相应的分量，然后把更新后的距离向量**全量**发送给自己的**邻居**
- 特点
	1. 简单 
	2. 报文大小与**节点数量正相关**，**不利于大型系统**
	3. **分布式**路由算法：以迭代的、分布式的方式计算最低费用路径
	4. **好消息收敛快，坏消息收敛慢**
- 协议 RIP协议
#### 链路状态方法（Link State）
- 理论基础 **dijk算法**
- 维护的状态 **全局链路拓扑图**（就像是地图，只要我对整个系统的地图很熟悉，开车就知道怎么走）
- 大致流程
	- 定期检查邻居状态，更新相邻链路信息
	- 定期把自己的**相邻链路信息广播给整个网络的全部节点**
	- 当自己收到链路状态报文时，更新自己的**全局链路拓扑图**，一旦状态发生变化就用dijk算法更新路由表
- 特点
	1. 是**全局**路由算法，所有路由器拥有完整的网络拓扑信息和链路费用信息
	2. 没有**慢收敛**问题，对坏消息响应迅速
	3. 存储空间开销 维护全局状态
	4. 拓扑变化都要重新计算最小代价树开销大
	5. 适合大型系统
- 协议 OSPF协议
#### 路径向量
- 协议 BGP
- 与[[#距离向量方法（Distance Vector）]]区分
## 层次化路由
### 概念
AS（Autonomous System）,网络世界中的自治邦国
### IGP（Internal Gateway Protocol）内部网关协议
- RIP
- OSPF
### EGP（External Gateway Protocol）外部网关协议
- BGP（Border Gateway Protocol）
## RIP（Router Information Protocol）
### 下层协议
**UDP**端口号520
### 规定
- 距离 到目标网络的跳数，RIP允许一个路径最多包含15个路由器，跳数为**16表示不可达**，距离向量算法可能出现环路，**规定跳数上限避免循环**
- 距离向量 自己到其他所有节点距离的集合
- 路由表 `表项结构 ::= <目标网络> <距离> <下一跳>`
### 伪代码
#### 定时交换信息
```
交换信息() => {
	for neighbor in neighbors {
		send(neighbor, routerTable)
	}
}
timer.every(交换信息, 30s)
```
#### 超时 
邻居好久（180s）没跟我说过话了我当他死了吧
```
timeouts = neighbors.map(neighbour => 
	timer.once(() => {
		把路由表以这个邻居为下一跳的表项设为不可达
		if routerTable is modified {
			交换信息()
		}
	}, 180s)
)
```
#### 当收到rip报文
```
event.on(收到报文, ({table, sender}) => {
	timeouts[sender].reset() //这回跟我说过话了先不当你死了
	let table = table.map(
		({target: _ , distance, next: _ }@entry) => ({
			...entry,
			distance: distance + 1,
			next: sender 
		})
	)
	for { target, distance, next }@entry in table {
		if target not in routerTable {
			routerTable.insert(entry)
		} else if routerTable[target].next == next {
			routerTable.entry(target).replace_with(entry) // 以最新的为准
		} else if routerTable[target].distance > distance {
			routerTable.entry(target).replace_with(entry) // 以距离较小的为准
		} else {
			do nothing
		}
	}
	if routerTable is modified {
		交换信息()
	}
}
```
### 优缺点
1. 同上面[[#距离向量方法（Distance Vector）]]中所介绍的
2. 最大跳数为15限制了网络的规模
## OSPF（Open Shortest Path First）
### 下层协议
**IP**协议号是89
### 特点
- **洪泛（广播）** 自己相连的链路状态
- 没有定期交换信息的机制与RIP[[#定时交换信息]]不一样
- 同[[#链路状态方法（Link State）]]
- 代价的定义不是基于跳数
- 对于不同类型的业务可以定义不同的代价，以实现QOS
- 当到目的网络有多条相同代价的路径可以把分组在多条路径间负载均衡
- 支持鉴权，从而只在可信的路由器上交换链路状态信息
- 支持可变长度子网划分和cidr
- 序号机制，序号越大分组传递的状态越新
### 分组类型
- 问候分组 邻居发现和维护可达性
- 数据库描述分组 传递链路状态的摘要信息
- 数据库请求分组 请求数据库某些项目的详细信息
- 链路状态更新分组 用**洪泛法**对整个网络同步链路状态
- 链路状态确认分组 对更新分组的确认

在网络中通常传送的 OSPF 分组大多是问候分组。两个相邻路由器通常每隔 10 秒要交换一次问候分组，以便知道哪些站可达。若有40秒没有收到某个相邻路由器发来的问候分组，则以为该相邻路由器不可达，应立即修改链路状态数据库，并重新计算路由表。
在路由器刚开始工作时，OSPF 让每个路由器使用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息。然后，路由器使用链路状态请求分组，向对方请求发送自己所换少的某些链路状态项目的详细信息。经过一系列的这种分组交换，就建立了全网同步的链路数据库。图4.17给出了 OSPF的基本操作，说明了两个路由器需要交换的各种类型的分组。![892B0765C407D38F541171A7A5C6D344](https://r2.pipago360.site/pupahub/2024/09/892b0765c407d38f541171a7a5c6d344.png)
在网络运行的过程中，只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态。其他路由器在收到更新分组后要发送确认。
为了确保链路状态数据库与全网的状态保持一致，OSPF 还规定每隔一段时间（如30分钟）要刷新一次数据库中的链路状态。因为一个路由器的链路状态只涉及与相邻路由器的连通状态，与整个网络的规模并无直接关系，所以当互联网规模很大时，OSPF 要比RIP好得多
## BGP
### 下层协议
**TCP**端口号179
### 概念
- BGP Speaker 自治系统之间的外交发言人
	- 发送BGP消息的路由器称为BGP发言者（BGP Speaker），它接收或产生新的路由信息，并发布（Advertise）给其它BGP发言者。当BGP发言者收到来自其它自治系统的新路由时，如果该路由比当前已知路由更优、或者当前还没有该路由，它就把这条路由发布给自治系统内所有其它BGP发言者。
	- 运行了BGP的边界路由器，就是BGP发言者。
- BGP对等体
	- 对等体（Peer）
	- 若干相关的对等体可以形成对等体组（Peer Group）
![Pasted image 20240728201111](https://r2.pipago360.site/pupahub/2024/09/bd48ba75d27ef32c64a0558a74a39418.png)
### 过程
- 与其他AS的邻站BGP发言人交换信息
- 交换的网络可达性的信息，即要到达某个网络所要**经过的一系列AS**
- 发生变化时更新**有变化的部分**
实际上，BGP交换的是各个发言人所掌握的路径向量。
BGP报文本质是TCP报文，是**应用层协议**。
### 特点
- BGP支持CIDR，因此BGP的路由表也就应当包括**目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的 各个自治系统序列**
- 在BGP刚刚运行时，BGP的邻站是交换**整个**的BGP路由表。但以后只需要在发生变化时更新有**变化的部分**。这样 做对节省网络带宽和减少路由器的处理开销都有好处
### BGP-4报文类型
- OPEN（打开）报文
    - 用来与相邻的另一个BGP发言人建立关系，并认证发送方。
- UPDATE（更新）报文
    - 通告新路径或撤销原路径
- KEEPALIVE（保活）报文
    - 在无UPDATE时，周期性证实邻站的连通性
    - 也作为OPEN的确认
- NOTIFICATION（通知）报文
    - 报告先前报文的差错
    - 也被用于关闭连接。