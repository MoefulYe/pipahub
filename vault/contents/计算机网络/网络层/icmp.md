---
created_at: 2024-07-26
modified_at: 2024-07-26
description: 
aliases: 
tags:
  - 计算机网络
title: ICMP
---
Internet Control Manage Protocol
## 报文格式
![Pasted image 20240728154452](https://r2.pipago360.site/pupahub/2024/09/43f106ad61e2bbab23f27a4acee3e146.png)
ICMP报文的种类有2种，即ICMP**差错报告报文**和**ICMP询问报文**。ICMP报文的前4个字节是统一的格式，共有三个字段：类型、代码、检验和。**接着的4个字节的内容与ICMP的类型有关**，最后面是数据字段，其长度取决于ICMP的类型，下表给出了几种常用的ICMP报文类型
### 数据字段
所有的ICMP差错报告报文中的数据字段都具有同样的格式，如下图所示：
![Pasted image 20240728155331](https://r2.pipago360.site/pupahub/2024/09/a67e3351e0b6cf4931c83f28dede1e62.png)
把收到的需要进行差错报告的IP数据报的首部和数据字段的前8个字节提取出来，作为ICMP报文的数据字段，再加上相应的ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文。提取收到的数据报的数据字段前8个字节是为了得到**运输层的端口号（TCP、UDP）以及运输层报文的发送序号（TCP）。**
**icmp里包装有问题的分组（的一部分）, 然后icmp分组再包在一个新的ip分组**
## 种类
![Pasted image 20240728154553](https://r2.pipago360.site/pupahub/2024/09/50a8115ba251117d91af41b257a42076.png)
- 差错报文
	- 终点不可达 
		当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。比如端口号不存在
	- 事件超过
		当路由器收到生存时间为0的数据报时，除了丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文
	- 参数问题
		当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文
	- 重定向
		路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（有更好的路由）。
- 询问报文
	- 回送请求和回答 测试目的站是否可达以及了解其有关状态
	- 时间戳请求和回答 时间戳请求与回答可用于时钟同步和时间测量。
## 不应发送ICMP差错报告报文的几种情况
- **对ICMP差错报告报文，不再发送ICMP差错报告报文**
- **对第一个分片的数据报片的所有后续数据报片，都不发送ICMP差错报告报文**
- **对具有多播地址的数据报，都不发送ICMP差错报告报文**
- **对具有特殊地址（127.0.0.1 | 0.0.0.0）的数据报，不发送ICMP差错报告报文**
## 应用
### Ping
ping使用回送请求和回答来实现
### Traceroute
`traceroute`程序开始时发送一个`TTL`字段为1的`UDP`数据报（选择一个不可能的值作为`UDP`端口号），然后将`TTL`每次加1，以确定路径中每个路由器。每个路由器在丢弃`UDP`数据报的时候都返回一个`ICMP`超时报文（如：`ICMP time exceeded in-transit`, length 36），而最终主机则产生一个`ICMP`端口不可达报文（如： `ICMP 74.125.128.103 udp port 33492 unreachable`, length ）。
对每个`TTL`，发送3份数据报，并且计算打印出往返时间。如果5秒内未收到任意一份回应，则打印一个星号。
需要注意的是：
1. 并不能保证现在的路由就是将来所采用的路由；
2. 不能保证`ICMP`报文的路由与`traceroute`程序发出的`UD`P数据报采用同一路由；
3. 返回的`ICMP`报文中信源的`IP`地址是`UDP`数据报到达的路由器接口的`IP`地址。